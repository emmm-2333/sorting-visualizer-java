# 操作整理：新增上一步/下一步、操作回显、柱子区分度与界面美化

日期：2025-12-25

## 1. 目标与原则

### 1.1 需求覆盖

- 新增“上一步/下一步”按钮，并回显每一步做了什么操作。
- 优化柱子显示：柱子之间更容易区分。
- 美化整体界面：偏 Apple 风格（浅色、克制、圆角、干净）。
- 在改造前先理解现有代码，并保持松耦合。

### 1.2 关键设计决定（为什么这样做）

现有动画模式是“算法实时执行 + 回调 UI”（`SortStepListener` -> `VisualizerPane`）。
- 这种模式天然不支持可靠的“上一步”，因为算法状态不可逆、且没有撤销信息。

因此改为：
- **先录制操作序列**（仅记录 compare/swap/set 等操作，不做 UI），
- **再回放操作序列**（支持 `apply/undo`），从而实现真正的“上一步/下一步”。

该方案对算法实现完全无侵入：算法仍只负责调用 `SortStepListener`。

## 2. 功能改动说明

### 2.1 新增：上一步/下一步 + 操作回显

- UI：新增按钮 `上一步`、`下一步`，并新增显示区：
  - `步骤: 当前/总数`
  - `当前操作: ...`
- 交互：
  - 自动回放时点击 `上一步/下一步` 会自动暂停，避免状态跳动。
  - `暂停/继续` 控制的是“回放进度”，不是算法执行线程。

### 2.2 柱子显示优化

- 柱子间距：增加 `BAR_GAP`，避免柱子贴在一起。
- 柱子视觉：圆角 + 细描边。
- 区分度：按值映射亮度（同色相不同明度），同一屏幕更容易看出差异。
- 高亮：比较/交换/设置时使用不同高亮颜色。

### 2.3 苹果风格浅色 UI

- 新增 JavaFX CSS：浅灰背景、白色卡片感、圆角控件、干净边框、蓝色滑块。
- 在应用启动时把 CSS 加入 Scene。

## 3. 代码结构调整（松耦合实现）

### 3.1 新增“步骤录制/回放”模块

新增包：`org.example.sortingvisualizer.step`

- `SortOperationType`：操作类型（COMPARE / SWAP / SET）
- `SortOperation`：统一操作接口（`apply/undo/description`）
- `CompareOperation`：比较操作（不修改数组，仅用于高亮与回显）
- `SwapOperation`：交换操作（可撤销：再 swap 一次）
- `SetOperation`：赋值操作（可撤销：记录 oldValue/newValue）
- `RecordedSort`：一次排序的录制结果（初始数组 + 操作列表）
- `StepPlayer`：回放器（维护 cursor，提供 next/prev，返回当前数组）

新增服务：`StepRecordingService`
- 负责把 `Sorter.sort(..., SortStepListener)` 的回调转换为可回放的 `SortOperation` 列表。
- 关键点：
  - 使用独立的 state 数组推导 `SetOperation` 的 oldValue（保持可撤销）。
  - 不修改算法实现，也不依赖 UI。

### 3.2 Controller 接入方式

`MainController` 的排序流程改为：
1. 禁用输入控件，创建后台 `Task<RecordedSort>` 录制步骤。
2. 录制成功 -> 初始化 `StepPlayer` -> 自动回放（`PauseTransition`）
3. `暂停/继续` 控制回放定时器。
4. `上一步/下一步` 使用 `StepPlayer.prev()/next()` 并更新 UI。
5. `退出排序` 停止回放并恢复到排序前数组。

### 3.3 VisualizerPane 渲染优化

- 新增 `renderState(int[] newArray, int index1, int index2, Color highlightColor)`：
  - 一次性更新数组并绘制高亮，避免 `updateArray + highlight` 两次重绘。
- 绘制改为：
  - 间距、圆角、描边
  - 颜色按 value 映射亮度

## 4. 具体修改文件清单

### 4.1 新增文件

- src/main/java/org/example/sortingvisualizer/step/SortOperationType.java
- src/main/java/org/example/sortingvisualizer/step/SortOperation.java
- src/main/java/org/example/sortingvisualizer/step/CompareOperation.java
- src/main/java/org/example/sortingvisualizer/step/SwapOperation.java
- src/main/java/org/example/sortingvisualizer/step/SetOperation.java
- src/main/java/org/example/sortingvisualizer/step/RecordedSort.java
- src/main/java/org/example/sortingvisualizer/step/StepPlayer.java
- src/main/java/org/example/sortingvisualizer/service/StepRecordingService.java
- src/main/resources/org/example/sortingvisualizer/view/apple.css

### 4.2 修改文件

- src/main/resources/org/example/sortingvisualizer/view/MainLayout.fxml
  - 新增 `prevStepButton`/`nextStepButton`
  - 新增 `stepLabel`/`operationLabel`
- src/main/java/org/example/sortingvisualizer/controller/MainController.java
  - 接入录制/回放模式，提供上一/下一步与操作回显
- src/main/java/org/example/sortingvisualizer/view/VisualizerPane.java
  - 柱子渲染优化 + `renderState`
- src/main/java/org/example/sortingvisualizer/SortingVisualizerApp.java
  - Scene 加载 apple.css

## 5. 使用说明（验收点）

1. 点击“开始排序”后：
   - 会先短暂显示“正在准备步骤...”，随后进入回放。
2. 回放过程中：
   - `暂停`：停止自动回放。
   - `继续`：恢复自动回放。
   - `上一步/下一步`：单步回退/前进，并在“当前操作”处显示本步含义。
3. 任意时刻点击“退出排序”：
   - 恢复到开始排序前的数组。

## 6. 可选优化建议（后续可做）

- 大数据量的性能与体验：为 $O(n^2)$ 算法增加“最大回放步数/抽样回放”，避免操作序列过长。
- 快捷键：←/→ 上一步/下一步，Space 暂停/继续。
- 统计信息：比较次数/交换次数/写入次数，帮助理解不同算法特性。
- 统一 TabPane/Chart 的 CSS，让性能比较页也更接近同一套视觉语言。

## 7. 第二轮增强（快捷键、统计栏、Benchmark 扩展与进一步美化）

本轮新增/调整点：

### 7.1 快捷键

- `←`：上一步
- `→`：下一步
- `Space`：暂停/继续

实现位置：在 `rootPane` 的 Scene 就绪后注册 `KeyEvent.KEY_PRESSED` 过滤器。
为避免影响输入体验，若焦点在输入框/下拉框/滑块上，则不会拦截快捷键。

### 7.2 统计栏（帮助理解算法特性）

UI 新增：
- `比较: 当前/总`
- `交换: 当前/总`
- `写入: 当前/总`

实现方式：
- 在录制完成后对操作序列做一次遍历，生成 compare/swap/set 的前缀计数数组。
- 每次步进/回放只需 O(1) 读取 `prefix[cursor]` 即可更新当前统计。

### 7.3 性能比较页扩展（更多内容）

新增 Tab：`摘要`
- 显示数据类型、规模、参与算法数
- 统计耗时：最快/最慢/平均/中位数
- 统计内存：最小/最大

### 7.4 数值标签默认显示

- `VisualizerPane` 默认开启数值标签。
- `showValuesCheckbox` 默认选中。

### 7.5 柱子最大宽度 + 居中

- 新增 `MAX_BAR_WIDTH`：当数据量过小时限制柱子过宽。
- 当柱子总宽度小于画布时，柱子整体水平居中显示。

### 7.6 继续美化（下拉列表、TabPane、Chart、TableView）

- `apple.css` 增加了 ComboBox 弹出列表样式。
- 对 `TabPane`、`BarChart`、`TableView` 增加统一的浅色边框/选中态/文字颜色。

## 8. 文件清单更新（新增/修改）

修改文件：
- src/main/resources/org/example/sortingvisualizer/view/MainLayout.fxml
  - `showValuesCheckbox` 默认选中
  - 新增统计栏 labels：`compareCountLabel`/`swapCountLabel`/`setCountLabel`
- src/main/java/org/example/sortingvisualizer/view/VisualizerPane.java
  - 默认显示数值标签
  - 柱子最大宽度 + 居中
  - 调整配色曲线
- src/main/resources/org/example/sortingvisualizer/view/apple.css
  - ComboBox 下拉列表、TabPane、Chart、TableView 样式增强
- src/main/java/org/example/sortingvisualizer/controller/MainController.java
  - 快捷键支持
  - compare/swap/set 统计更新
  - Benchmark 新增“摘要”Tab

---

备注：本次整理以“松耦合、尽量不侵入算法实现”为首要原则，新增的步骤系统独立于算法与 UI，可单独测试与扩展。

## 9. 第三轮微调（柱子变亮、Benchmark 更美观、猴子排序不统计次数）

### 9.1 柱子颜色偏暗问题修正

问题：柱子整体亮度下限偏低，视觉上容易“发黑”。

调整：
- 将柱子颜色映射改为更高的亮度区间（整体更明亮），并略微降低饱和度，让蓝色更克制。

涉及文件：
- src/main/java/org/example/sortingvisualizer/view/VisualizerPane.java

### 9.2 性能比较页观感增强

调整点（CSS 层面）：
- Tab 内容区增加 padding（更像卡片内容布局，不贴边）。
- Chart 增加内边距、柱子圆角、图例透明背景。
- Table 增加 hover 行高亮，提升可读性与交互反馈。

涉及文件：
- src/main/resources/org/example/sortingvisualizer/view/apple.css

### 9.3 猴子排序（BogoSort）排除“步骤统计次数”

背景：猴子排序步骤数量不可控、波动大，且可能非常巨大；“比较/交换/写入次数”统计意义不强，还可能影响体验。

处理方式：
- 当选择算法为“猴子排序”时，步骤统计栏显示为 `-/-`。
- 不再构建 compare/swap/set 的前缀统计数组，避免额外开销。

涉及文件：
- src/main/java/org/example/sortingvisualizer/controller/MainController.java

## 10. 推荐可完善/新增的功能（可选）

以下是一些“对教学演示更有价值、且与当前架构兼容”的增强方向：

1) 步骤系统增强
- 支持“跳到指定步数/拖动进度条”：利用 StepPlayer 的 cursor 可直接实现。
- 支持“自动回放时动态调速更平滑”：改为每 tick 读取 slider 并重新调度。

2) 统计维度更丰富
- 增加“总操作数 / 当前步骤类型占比”。
- Benchmark 增加标准差/方差（体现波动）、以及按耗时/内存排名。

3) Benchmark 展示体验
- 给图表柱子添加 tooltip（悬停显示 ms/MB 与算法名）。
- 增加“导出 CSV”按钮，方便写报告/做对比。

4) 教学辅助信息
- 在算法下拉选择后显示“稳定性/时间复杂度/空间复杂度”的简介卡片。
- 高亮区旁显示本步解释更结构化（例如：比较 i 与 j / 交换 i 与 j / 写入 k）。

## 11. 第四轮增强（稳定性保护、完成态配色、Tooltip 与 Controller 减重）

### 11.1 猴子排序大数据保护

问题：猴子排序（BogoSort）在数据量稍大时步骤数阶乘级爆炸，容易导致录制序列过大、内存耗尽或长时间卡死。

处理：
- 在开始排序时对“猴子排序”增加数据规模上限保护（n>9 直接弹窗提示并阻止执行）。

涉及文件：
- src/main/java/org/example/sortingvisualizer/controller/MainController.java

### 11.2 排序完成态统一绿色（且不与交换色冲突）

需求：排序完成后希望整组数据呈绿色，但不能与“交换”高亮绿色冲突。

处理：
- 交换高亮色保持绿色（便于直觉理解“交换”）。
- 新增完成态渲染：回放到末尾时把所有柱子统一渲染为绿色（与交换绿为相近但不同的两种系统绿，仍可区分）。

涉及文件：
- src/main/java/org/example/sortingvisualizer/view/VisualizerPane.java
- src/main/java/org/example/sortingvisualizer/controller/MainController.java

### 11.3 性能比较图表柱子 Tooltip（ms/MB）

新增：
- 时间图表柱子悬停显示：算法名 + `xx.xx ms`
- 内存图表柱子悬停显示：算法名 + `xx.xx MB`

涉及文件：
- src/main/java/org/example/sortingvisualizer/view/BenchmarkViewBuilder.java
- src/main/resources/org/example/sortingvisualizer/view/apple.css（Tooltip 样式）

### 11.4 MainController 减重：抽离 Benchmark 视图构建

背景：`MainController` 同时负责“流程编排 + 大段 UI 构建”，容易臃肿。

处理：
- 新增 `BenchmarkViewBuilder`：负责生成 benchmark 的 TabPane（摘要/时间/内存/表格）。
- `MainController` 只保留 `showBenchmarkResults(...)` 的“视图切换”职责，调用 builder 构建 UI。

涉及文件：
- 新增：src/main/java/org/example/sortingvisualizer/view/BenchmarkViewBuilder.java
- 修改：src/main/java/org/example/sortingvisualizer/controller/MainController.java

### 11.5 Benchmark 柱子圆角与 Tooltip 细节

- 为确保柱子圆角在不同平台/缩放下都生效，补充了 `-fx-background-insets` 与按角设置的 `-fx-background-radius`。
- Tooltip 增加统一浅色卡片风格（圆角、边框、padding）。

涉及文件：
- src/main/resources/org/example/sortingvisualizer/view/apple.css

## 12. 第五轮增强（回放控制抽离：PlaybackController）

目标：进一步“松耦合 + 瘦身”，把回放控制/状态管理从 `MainController` 中抽离。

实现：新增 `PlaybackController`
- 只暴露：`load/start/pause/next/prev/stop` 与事件回调
- 内部封装：`StepPlayer` + 自动回放定时（JavaFX `PauseTransition`）
- Controller 只处理：录制任务、控件 enable/disable、以及根据回调更新 UI

涉及文件：
- 新增：src/main/java/org/example/sortingvisualizer/playback/PlaybackController.java
- 新增：src/main/java/org/example/sortingvisualizer/playback/PlaybackSnapshot.java
- 修改：src/main/java/org/example/sortingvisualizer/controller/MainController.java
